# ナレッジベース（Knowledge Base）

Claude Codeを使ったAI駆動開発における、インプットドキュメントの改善点と学びをまとめます。

---

## 1. 事前ドキュメントの評価

### 良かった点

| ドキュメント | 評価 | 理由 |
|-------------|------|------|
| CLAUDE.md | ◎ | プロジェクト概要、技術スタック、フェーズが簡潔にまとまっていた |
| PHASES.md | ◎ | フェーズ分割と完了条件が明確で、段階的実装がスムーズ |
| DATABASE.md | ○ | テーブル定義、RLS、インデックスが網羅的 |
| REQUIREMENTS.md | ○ | 機能一覧と画面構成が明確 |
| ARCHITECTURE.md | △ | 理想形は示されていたが、実装時に乖離が発生 |
| CONVENTIONS.md | △ | 規約は明確だが、すべてを守る余裕がなかった |

### 改善が必要だった点

#### 1. ARCHITECTURE.md の乖離

**問題:** ドキュメントでは `(auth)` `(dashboard)` のルートグループを使用する設計だったが、実装ではシンプルなフラット構造を採用した。

**ドキュメント（計画）:**
```
src/app/
├── (auth)/
│   ├── login/
│   └── signup/
├── (dashboard)/
│   ├── dashboard/
│   ├── habits/
│   └── calendar/
```

**実際の実装:**
```
src/app/
├── auth/
│   ├── login/
│   └── signup/
├── dashboard/
├── habits/
├── calendar/
└── stats/
```

**教訓:**
- 小規模プロジェクトでは過度な構造化は不要
- 実装開始前に「このプロジェクト規模に適切か？」を検討する
- ドキュメントには「推奨」と「必須」を明記する

#### 2. Server Components vs Client Components

**問題:** ARCHITECTURE.mdではServer Componentsを推奨していたが、実際はほぼ全てClient Componentsで実装。

**理由:**
- 認証状態の取得にクライアントサイドが必要
- インタラクティブな操作（チェック、数値入力）が多い
- リアルタイム更新が必要

**教訓:**
- Server Components が適切なケースを具体的に示す
- 「この機能はServer/Clientどちらで実装すべきか」のガイドラインを追加

#### 3. カスタムフックの未使用

**問題:** ARCHITECTURE.mdでは `hooks/` ディレクトリに `use-habits.ts`, `use-logs.ts` などを想定していたが、実際は作成しなかった。

**理由:**
- 各ページで直接Supabaseを呼び出す方がシンプルだった
- フックの抽象化による再利用メリットが小さかった

**教訓:**
- 「フックを作るべき基準」を明記（3箇所以上で同じロジックを使う場合など）
- 最初から完璧な抽象化を目指さない

---

## 2. インプットドキュメント改善提案

### CLAUDE.md の改善

```markdown
## 現在のフェーズ

**Phase 1: プロジェクト初期化 + 認証**

## 開発の進め方

1. 各フェーズは順番に実装する
2. フェーズ完了時に必ずビルド確認を行う
3. 完了条件をすべて満たしてから次のフェーズに進む
4. 問題発生時は即座に報告し、解決してから続行

## 環境構築の前提条件  ← 追加

- Node.js 18以上
- npm または yarn
- Supabaseプロジェクト（事前作成済み or 作成手順を用意）
- Vercelアカウント（デプロイ用）

## よくあるトラブルと対処法  ← 追加

| 問題 | 原因 | 対処法 |
|------|------|--------|
| ビルドエラー | 環境変数未設定 | .env.local を確認 |
| 認証エラー | Supabase URL設定漏れ | ダッシュボードで確認 |
```

### PHASES.md の改善

```markdown
## Phase 1: プロジェクト初期化 + 認証

### タスク
- [ ] Next.js プロジェクト作成
- [ ] ...

### 完了条件
- [ ] ログイン/サインアップが動作する
- [ ] ...

### 確認コマンド  ← 追加
```bash
npm run build  # ビルドが通ること
npm run lint   # lintエラーがないこと
```

### 想定される問題と対処法  ← 追加
- **問題:** 環境変数エラー
- **対処:** .env.example をコピーして .env.local を作成
```

### ARCHITECTURE.md の改善

```markdown
## 実装パターンの選択基準  ← 追加

### Server Components を使うケース
- 静的なデータ表示のみ
- SEOが重要なページ
- 初期データフェッチ

### Client Components を使うケース
- ユーザーインタラクションがある
- リアルタイム更新が必要
- 認証状態に依存する

## ディレクトリ構造

### シンプル版（推奨：小〜中規模）  ← 追加
```
src/app/
├── auth/
├── dashboard/
├── habits/
└── calendar/
```

### 拡張版（大規模プロジェクト向け）
```
src/app/
├── (auth)/
├── (dashboard)/
...
```
```

### DATABASE.md の改善

```markdown
## Supabase セットアップ手順  ← 追加

1. https://supabase.com でプロジェクト作成
2. Settings > API から URL と anon key を取得
3. SQL Editor で schema.sql を実行
4. Authentication > URL Configuration を設定

## トリガーの注意点  ← 追加

デフォルトカテゴリ作成トリガーは、権限の問題で
失敗する可能性があります。

**推奨:** トリガーは使わず、アプリ側で初回ログイン時に
カテゴリを作成する方式を採用する。
```

### REQUIREMENTS.md の改善

```markdown
## 画面構成

| パス | 画面名 | 認証 | 優先度 |  ← 優先度追加
|------|--------|------|--------|
| `/` | ランディング | 不要 | P1 |
| `/dashboard` | ダッシュボード | 必須 | P1 |
| `/habits` | 習慣一覧 | 必須 | P1 |
| `/calendar` | カレンダー | 必須 | P2 |
| `/stats` | 統計 | 必須 | P2 |
| `/help` | ヘルプ | 必須 | P3 |

## UI/UX 要件  ← 追加

- ツールチップで操作説明を表示
- 初回ログイン時にチュートリアル表示
- ローディング状態を明示
- エラー時はトーストで通知
```

---

## 3. AI駆動開発のベストプラクティス

### ドキュメント作成時

1. **フェーズ分割を明確に**
   - 各フェーズは独立してテスト可能に
   - 完了条件を具体的に（「動作する」ではなく「ログインしてダッシュボードに遷移できる」）

2. **技術選定の理由を記載**
   - 「なぜServer Componentsではなく Client Components か」
   - 代替案と比較した選定理由

3. **トラブルシューティングを事前に用意**
   - 想定される問題と対処法
   - 確認コマンド一覧

4. **柔軟性を持たせる**
   - 「推奨」と「必須」を明記
   - 規模に応じた選択肢を提示

### 開発進行時

1. **各フェーズ完了時にビルド確認**
   ```bash
   npm run build && npm run lint
   ```

2. **問題発生時は即座に対処**
   - 後回しにすると複雑化する
   - 小さな問題のうちに解決

3. **ドキュメントと実装の乖離を許容**
   - 実装しながら最適解を見つける
   - 最終的にドキュメントを更新

4. **コミットは機能単位で**
   - フェーズ完了時に必ずコミット
   - 問題発生時にロールバック可能に

---

## 4. 次回プロジェクトへの推奨テンプレート

### CLAUDE.md テンプレート

```markdown
# プロジェクト名

## 概要
[1-2行でプロジェクトの目的を説明]

## 技術スタック
- **フロントエンド:** Next.js, TypeScript, Tailwind CSS
- **バックエンド:** [使用するサービス]
- **デプロイ:** Vercel

## 現在のフェーズ
**Phase X: [フェーズ名]**

## 環境構築
```bash
npm install
cp .env.example .env.local
# .env.local を編集
npm run dev
```

## 確認コマンド
```bash
npm run build  # ビルド確認
npm run lint   # lint確認
npm run dev    # 開発サーバー
```

## ドキュメント
| ファイル | 内容 |
|---------|------|
| docs/REQUIREMENTS.md | 機能要件 |
| docs/PHASES.md | 開発フェーズ |
| docs/DATABASE.md | DB設計 |

## トラブルシューティング
| 問題 | 対処法 |
|------|--------|
| ビルドエラー | 環境変数確認 |
| 認証エラー | [サービス]の設定確認 |
```

---

## まとめ

今回の開発で得られた最も重要な学び：

1. **ドキュメントは「完璧」より「実用的」を優先**
   - 詳細すぎると実装との乖離が発生
   - 柔軟性を持たせた記述が有効

2. **フェーズ分割と完了条件が成功の鍵**
   - 明確なゴールがあると進捗が見える
   - 段階的に動くものを作ることでモチベーション維持

3. **トラブルシューティングの事前準備が効率を上げる**
   - よくある問題を事前にドキュメント化
   - 環境構築手順を詳細に記載

4. **AI駆動開発では「対話」が重要**
   - 問題発生時は即座に共有
   - 追加要望は適切なタイミングで
